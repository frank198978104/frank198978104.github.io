---
layout: post
title:  "JavaScript 作用域和作用域鏈"
date:   2015-05-20 14:06:05
categories: Front-end JavaScript
excerpt: JavaScript作用域和作用域鏈學習筆記。
---

* content
{:toc}

## JavaScript 作用域 

作用域就是變量與函數的可訪問範圍。在JavaScript中，變量的作用域有全局作用域和局部作用域兩種。

---

### 全局作用域(Global Scope)

在代碼中任何地方都能訪問到的對象擁有全局作用域，一般來說以下 3 種情形擁有全局作用域。

1. 最外層函數和在最外層函數外面定義的變量擁有全局作用域
2. 所有末定義直接賦值的變量自動聲明為擁有全局作用域
3. 所有window對象的屬性擁有全局作用域   
    window對象的內置屬性都擁有全局作用域，例如window.name、window.location、window.top等。

### 局部作用域(Local Scope)

和全局作用域相反，局部作用域一般只在固定的代碼片段內可訪問到，最常見的例如函數內部，所有在一些地方也會看到有人把這種作用域稱為函數作用域
。

---

## 作用域鏈(Scope Chain)

在 JavaScript 中，函數也是對象，實際上，JavaScript 裡一切都是對象。函數對象和其它對象一樣，擁有可以通過代碼訪問的屬性和一系列僅供 JavaScript 引擎訪問的內部屬性。其中一個內部屬性是 [[Scope]]，由 ECMA-262 標準第三版定義，該內部屬性包含了函數被創建的作用域中對象的集合，這個集合被稱為函數的作用域鏈，它決定了哪些數據能被函數訪問。

1. 在函數創建時，它的作用域鏈中會填入一個全局對象，該全局對象包含了所有全局變量。
2. 函數執行時會創建一個稱為“運行期上下文(execution context)”的內部對象，運行期上下文定義了函數執行時的環境。每個運行期上下文都有自己的作用域鏈，用於標識符解析，當運行期上下文被創建時，而它的作用域鏈初始化為當前運行函數的[[Scope]]所包含的對象。
3. 這些值按照它們出現在函數中的順序被複製到運行期上下文的作用域鏈中。它們共同組成了一個新的對象，叫“活動對象(activation object)”，該對象包含了函數的所有局部變量、命名參數、參數集合以及this，然後此對象會被推入作用域鏈的前端。
4. 當運行期上下文被銷毀，活動對象也隨之銷毀。

在函數執行過程中，每遇到一個變量，都會經歷一次標識符解析過程以決定從哪裡獲取和存儲數據。該過程從作用域鏈頭部，也就是從活動對象開始搜索，查找同名的標識符，如果找到了就使用這個標識符對應的變量，如果沒找到繼續搜索作用域鏈中的下一個對象，如果搜索完所有對象都未找到，則認為該標識符未定義。函數執行過程中，每個標識符都要經歷這樣的搜索過程。

### 代碼優化

從作用域鏈的結構可以看出，在運行期上下文的作用域鏈中，標識符所在的位置越深，讀寫速度就會越慢。如上圖所示，因為全局變量總是存在於運行期上下文作用域鏈的最末端，因此在標識符解析的時候，查找全局變量是最慢的。所以，在編寫代碼的時候應盡量少使用全局變量，盡可能使用局部變量。一個好的經驗法則是：如果一個跨作用域的對象被引用了一次以上，則先把它存儲到局部變量裡再使用。

---

## 參考資料

* [鳥哥：Javascript作用域原理](http://www.laruence.com/2009/05/28/863.html)
* [理解 JavaScript 作用域和作用域鏈](http://www.cnblogs.com/lhb25/archive/2011/09/06/javascript-scope-chain.html)
